In this section, we show that the construction described in Section \ref{section:stlc} can be repeated almost unchanged for any model of simply-typed $\lambda$-calculus. First, we need a generic notion of simply-typed $\lambda$-calculus. Traditionally, one uses cartesian closed categories. However, since many usual examples (\textit{e.g.} Scott domains and continuous functions, coherent spaces and stable functions) are in fact poset-enriched categories, and since any category can be poset-enriched using equality as the ordering, we will consider \emph{a}

Model of simply-typed lambda calculus = ccc, nous on affaiblit en lax-clos (comme seely)

Structure VS propriété -> définition un peu non-standard

\begin{definition} Let $(\mathbb{C}, \times, 1)$ be a locally small (respectively, poset-enriched) cartesian category. An \emph{exponential} (respectively, a \emph{lax-exponential}) on $\mathbb{C}$ is the data of a map $\exp$ from $\operatorname{Ob}(\mathbb{C} \times \mathbb{C})$ to $\operatorname{Ob}(\mathbb{C})$ and two families of maps (respectively, monotone maps) $(\ev_{W,X,Y} : \mathbb{C}(W, \operatorname{exp}(X,Y)) \to \mathbb{C}(W \times X, Y))$ and $(\lam_{W,X,Y} : \mathbb{C}(W \times X, Y) \to \mathbb{C}(W, \exp(X,Y)))$ such that: \begin{itemize}
\item $\ev_{W,X,Y}$ and $\lambda_{W,X,Y}$ are natural with respect to $W$,
\item for all $g \in \mathbb{C}(W \times X, Y)$, $\ev(\lam(g)) = g$ (respectively, $\ev(\lam(g)) \leq g$),
\item for all $f \in \mathbb{C}(W, \exp(X,Y))$, $f = \lam(\ev(f))$ (respectively, $f \leq \lambda(\operatorname{ev}(f))$).
\end{itemize}
\end{definition}

One can check that this makes $\exp$ a functor (respectively, a lax-functor) from $\operatorname{Ob}(\mathbb{C}^{\operatorname{op}} \times \mathbb{C})$ to $\operatorname{Ob}(\mathbb{C})$ (with
$\exp(\alpha,\beta)=\lam(\beta\circ\ev(\id)\circ(\id\times\alpha))$).

For the rest of this section, we fix a locally small cartesian category $(\mathbb{C}, \times, 1)$ (we denote by $\langle-,-\rangle$ the pairing transformation and by $\pi_L$ and $\pi_R$ the projections) and an exponential $(\exp, \ev, \lam)$ on $\mathbb{C}$. The morphisms of this category represent \emph{exact programs}, so they play the role of the terms from Section \ref{section:stlc}.

\begin{definition} A \emph{$\mathbb{C}$-diameter space} $A$ is the data of \begin{itemize}
\item an object $\bs{A}$ of $\mathbb{C}$. The set $\mathbb{C}(1,\bs{A})$ will be denoted by $\Lambda_A$;
\item a subset $\intervals{A}$ of $\mathcal{P}(\Lambda_A)$ that is closed under arbitrary intersections. In particular, $\intervals{A}$ is a complete lattice whose meet is given by intersection, and for all $t\in\Lambda_A$, there is a least element of $\intervals{A}$ that contains $t$, which will be denoted by $\tointerval{t}$;
\item a commutative integral quantale $(\distances{A}, \quantaleop, \quantaleleq)$;
\item a monotonically decreasing function $\diam_A : \intervals{A} \to \distances{A}$ such that $$\forall a,b \in \intervals{A} \text{ s.t. } a \wedge b \neq \emptyset,~ \diam(a \wedge b) \quantaleop \diam(a \vee b) \quantalegeq \diam(a) \quantaleop \diam(b)\text{,}$$
and such that for all $t,u \in \Lambda_A$, if $\diam_A(\tointerval{t}) = \diam_A(\tointerval{t} \vee \tointerval{u})$, then $\tointerval{t} = \tointerval{t} \vee \tointerval{u}$.
\end{itemize}
\end{definition}

For example, if $\mathbb{C}$ is the category whose objects are the simple types from Section \ref{section:stlc} and whose morphisms are the (open) terms modulo $\beta$-equivalence, then for all simple types $A$, $(A, \intervals{A}, \distances{A}, \diam_A)$ defines a $\mathbb{C}$-diameter space.

Following Section \ref{section:stlc}, for all $\mathbb{C}$-diameter spaces $A$ and $B$, we define a $\mathbb{C}$-diameter space $A \times B$ such that $\bs{A \times B} = \bs{A} \times \bs{B}$ and a $\mathbb{C}$-diameter space $\exp(A,B)$ such that $\bs{\exp(A,B)} = \exp(\bs{A},\bs{B})$: \begin{itemize}
\item $\intervals{A \times B} = \{ a \times b \mid a \in \intervals{A}, b \in \intervals{B} \} $, where $a \times b = \{ t \in \mathbb{C}(1, \bs{A} \times \bs{B}) \mid \pi_L \circ t \in a \text{ and } \pi_R \circ t \in b \}$,
\item $\distances{A \times B} = \distances{A} \times \distances{B}$,
\item $\diam_{A \times B}(c) = (\diam_A(\{ \pi_L \circ t \mid t \in c \}), \diam_B(\{ \pi_R \circ t \mid t \in c \}))$,
\item $\intervals{\exp(A, B)} = \{ \{ t \in \mathbb{C}(1, \exp(\bs{A}, \bs{B})) \mid \forall u \in \Lambda_{A},~ \ev(t) \circ u \in I(u) \} \mid I : \Lambda_A \to \intervals{B} \}$,
\item $\distances{\exp(A, B)} = \{ \text{monotonically decreasing functions from } \intervals{A} \text{ to } \distances{B} \}$,
\item $\diam_\mathsf{\exp(A, B)}(c) = a \mapsto \diam_B\left(\sup\left\{\tointerval{\ev(v) \circ t} \mid t\in a, v \in c\right\}\right).$
\end{itemize}

We need a counterpart to Proposition \ref{prop:intervals-weak-model-lambda}, that is to say, we need to show that the $\mathbb{C}$-diameter spaces themselves organise as a model of simply-typed $\lambda$-calculus (in a weak sense). We will formalise this precisely in categorical terms, using the notion of \emph{lax-expenential}, so we need to define a notion of morphisms between two $\mathbb{C}$-diameter spaces $A$ and $B$ (which represent \emph{approximate programs}). By analogy with Section \ref{section:stlc}, these will be monotone functions from $\intervals{A}$ to $\intervals{B}$; however, in order to actually obtain a cartesian category (which was not an issue in Section \ref{section:stlc}), we will need to add an extra condition:

\begin{definition}
We denote by $\dsp(\mathbb{C})$ the poset-enriched category defined as follows: \begin{itemize}
\item the objects of $\dsp(\mathbb{C})$ are the $\mathbb{C}$-diameter spaces,
\item for all $\mathbb{C}$-diameter spaces $A$ and $B$, $\dsp(\mathbb{C})(A,B)$ is the set of all monotone functions $\varphi : \intervals{A} \to \intervals{B}$ such that there exists $u \in \mathbb{C}(\bs{A},\bs{B})$ such that for all $t \in \Lambda_A$, $u \circ t \in \varphi\left(\tointerval{t}\right)$ (ordered by pointwise inclusion).
\end{itemize}
\end{definition}

One can check that the operation $-\times-$ defined above on $\mathbb{C}$-diameter spaces is a cartesian product in $\dsp(\mathbb{C})$. In addition, one can check that there exists in $\dsp(\mathbb{C})$ a terminal object $1_{\dsp(\mathbb{C})}$ such that $\bs{1_{\dsp(\mathbb{C})}} = 1_{\mathbb{C}}$. In other words, $\dsp(\mathbb{C})$ is cartesian. Here too, we denote by $\langle-,-\rangle$ the pairing transformation and by $\pi_L$ and $\pi_R$ the projections.


Now, following Section \ref{section:stlc}, we can define the lax-exponential: let $A,B,C$ be $\mathbb{C}$-diameter spaces, \begin{itemize}
\item for all $\varphi \in \dsp(\mathbb{C})(A, \exp(B, C))$, we define $\ev_{A,B,C}(\varphi) \in \dsp(\mathbb{C})\allowbreak(A \times B, C)$ by $\ev_{A,B,C}(\varphi)(p) = \sup\{ \tointerval{\ev(v) \circ u} \mid v \in \varphi(\pi_L(p)), u \in \pi_R(p) \}$,
\item for all $\psi \in \dsp(\mathbb{C})(A \times B, C)$, we define $\lam_{A,B,C}(\psi) \in \dsp(\mathbb{C})(A,\allowbreak \exp(B, C))$ by $\lam_{A,B,C}(\psi)(a) = \{ v \in \Lambda_{\exp(B, C)} \mid \forall u \in \Lambda_B,~ \ev(v) \circ u \in \psi(a \times \tointerval{u}) \}$.
\end{itemize}
 
 \begin{proposition} The triple $(\exp, \ev, \lam)$ is a lax-exponential on $\dsp(\mathbb{C})$.
 \end{proposition}
 \begin{proof} Naturality with respect to $A$ is immediate.
 
Let $p = a \times b \in \intervals{A \times B}$. For all $v \in \lam(\psi)(a)$ and and $u \in b$, by definition $\ev(u) \circ u \in \psi(a \times \tointerval{u}) \subseteq \psi(p)$. Therefore, $\ev(\lam(\psi))(p) \subseteq p$.
 
 Let $a \in \intervals{A}$ and $v \in \varphi(a)$. For all $u \in \Lambda_B$,  by definition, $\ev(v) \circ u \in \lambda(\varphi)(a \times \tointerval{u})$, so $v \in \lam(\ev(\varphi))(a)$.
\end{proof}
 
As in Section \ref{section:stlc}, we can find a kind of weak embedding from $\mathbb{C}$, to $\dsp(\mathbb{C})$. Namely, for all $\mathbb{C}$-diameter spaces $A$ and $B$, we define a map $\partial : \mathbb{C}(\bs{A}, \bs{B}) \to \dsp\allowbreak(\mathbb{C})(A, B)$ by $\partial(\beta)(a) = \sup \{ \tointerval{\beta \circ t} \mid t \in a \}$. The following compatibility result is immediate:

\begin{proposition} For all $\mathbb{C}$-diameter spaces $A, B, C$, all $\beta \in \mathbb{C}(A, B)$ and all $\gamma \in \mathbb{C}(B, C)$, $\partial(\gamma \circ \beta) \leq \partial(\gamma) \circ \partial(\beta)$. In addition, $\partial(\operatorname{id}_{\bs{A}}) = \operatorname{id}_A$.
\end{proposition}
 
One way to reformulate this result is that $\partial$ induces an oplax functor from the category with the same objects as $\dsp(\mathbb{C})$ and the same morphisms as $\mathbb{C}$, to $\mathbb{C}$.

One can check that $\partial$ preserves products, in the sense that $\partial (\langle \alpha, \beta \rangle) = \langle\partial(\alpha), \partial(\beta)\rangle$, $\partial(\pi_L) = \pi_L$ and $\partial(\pi_R) = \pi_R$. In addition $\partial$ is weakly compatible with the exponential:

\begin{proposition} Let $A, B, C$ be $\mathbb{C}$-diameter spaces, \begin{itemize}
\item for all $\varphi \in \mathbb{C}(\bs{A}, \exp(\bs{B}, \bs{C}))$, $\partial(\ev(\varphi)) \leq \ev(\partial(\varphi))$,
\item for all $\psi \in \mathbb{C}(\bs{A}\times\bs{B}, \bs{C})$, $\partial(\lam(\psi)) \leq \lam(\partial(\psi))$.
\end{itemize}
\end{proposition}

Finally, following Section \ref{section:stlc}, for all $\mathbb{C}$-diameter spaces $A$ and all  $t,u \in \Lambda_A$, we write $t \oeq_A u$ if $\tointerval{t} = \tointerval{u}$. In addition, we define a function $d_A : \Lambda_A \times \Lambda_A \to \distances{A}$ by $d_A(t,u) = \diam_A(\tointerval{t} \vee \tointerval{u})$. Then the same arguments as in Corollary \ref{corollary:stlc-metric} prove that:

\begin{proposition} For all $\mathbb{C}$-diameter spaces $A$, \emph{$(\Lambda_{A}/\oeq_{A}, \distances{A}, d_{A})$ is a partial metric space}.
\end{proposition}
 